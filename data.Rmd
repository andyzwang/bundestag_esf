---
title: "Daten und Methodik"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, rows.print = 5)
library(ggplot2)
library(tidyverse)
library(readxl)
library(janitor)
library(reactable)
```

Es gibt keine zentrale Datenbank für einzelne ESF+-Projekte in Deutschland, die öffentlich zugänglich ist. Daher werden in diesem Projekt die ESF+-Daten der 16 Bundesländer und des Bundes in einem einheitlichen Format zusammengeführt und mit Informationen über die geografischen Gegebenheiten auf verschiedenen Ebenen versehen.

## Methodik

### Geografische Vereinheitlichung

Die Projekte werden auf den geografischen Ebenen Stadt, Postleitzahl (PLZ), Bundestagswahlkreis (BWK) und Bundesland ausgewiesen. 

#### PLZ-BWK

Das Statistische Bundesamt veröffentlicht zwar einen Querverweis zwischen Wahlkreisen und Postleitzahlen, aber diese Daten sind nicht vollständig, da sie einen Eintrag für jede Gemeinde, den zugehörigen BWK und die primäre Postleitzahl der Verwaltung enthalten.^[[Statistisches Bundesamt](https://www.destatis.de/DE/Themen/Laender-Regionen/Regionales/Gemeindeverzeichnis/Administrativ/Archiv/GVAuszugQ/BTW20214Q2020.html), stand 7.1.2021] Das BFS hat keine vollständigen Daten veröffentlicht, angeblich aus Gründen des Urheberrechts.^["Aus lizenzrechtlichen Gründen darf das Statistische Bundesamt das vollständige Postleitzahlenverzeichnis (Urheber ist die Deutsche Post AG mit dem Produkt DATAFACTORY STREETCODE) nicht verbreiten. Der Lizenzvertrag mit der deutschen Post gestattet uns Auswertungen ausschließlich für interne Zwecke. Ohnehin ist jedoch eine Zuordnung von Postleitzahlen und Wahlkreisen in vielen Fällen nicht eindeutig möglich, da die Postleitzahlengebiete üblicherweise nicht entlang der Wahlkreisgrenzen verlaufen. Darüber hinaus liegt uns als kleinste systematisierte Gebietseinheit bei der Wahlkreiseinteilung die Gemeinde als Ganzes vor. Bei Gemeinden, die durch mehrere Wahlkreise 'geteilt' sind, fehlt uns eine weitere Differenzierung (z.B. nach Stadtteil, Bezirk, Straße), so dass hier ebenso eine eindeutige Zuordnung der Postleitzahlen nicht möglich ist" [[FragDenStaat](https://fragdenstaat.de/anfrage/veroffentlichung-einer-vollstandigen-liste-von-postleitzahlen-und-den-zugehorigen-wahlkreisen/), 26.2.2021].] 

Open-Source und öffentlich verfügbar [PLZ und BWK GeoJSON-Dateien](#geocoding) wurde verwendet, um einen Querverweis zwischen den beiden zu schaffen. Das R-Paket `sf` wurde verwendet, um die Grenzen dieser beiden Schichten zu vergleichen.

<details>
  <summary>PLZ-BWK Querverweis R Code [[Live](scripts/geo/plz_bwk_crosswalk.R)]</summary>
  ```r
  library(sf)
  library(dplyr)
  library(purrr)
  library(stringr)
  library(janitor)
  
  ## DATA IMPORT
  # Load PLZ shapefiles
  plz <- st_read("raw/shape_files/plz5.geojson") %>%
    clean_names() %>%
    select(plz, note, everything()) %>%
    rename(
      plz_name = note,
      plz_einwohner = einwohner,
      plz_qkm = qkm
    ) %>%
    mutate(
      plz_name = str_replace(plz_name, paste(plz, " ", sep = ""), ""),
      plz_name = str_replace(plz_name, "  ", " ")
    ) %>%
    filter(
      plz_einwohner > 10
    )
  
  # Load wahlkreis names
  wk_namen <- read.csv("raw/wahlkreisnamen.csv", skip = 7) %>%
    select(-LAND_NR, -LAND_ABK)
  
  # Load BWK data
  bwk <- st_read("raw/shape_files/wkr.json") %>%
    select(WKR_NR, LAND_NR) %>%
    inner_join(wk_namen, by = c("WKR_NR")) %>%
    clean_names() %>%
    select(wkr_nr, wkr_name, land_nr, land_name)
  
  ## FULLY CONTAINED DISTRICTS
  # Identify all PLZs that are fully enclosed within BWKs (obs: 2815)
  
  full_contains <- st_join(bwk, plz, join = st_contains_properly) %>%
    mutate(wk_pct = 1) %>%
    st_drop_geometry()
  
  # filter out the list of remaining PLZs
  plz <- plz %>%
    filter(!plz %in% full_contains$plz)
  
  ## PARTIALLY CONTAINED DISTRICTS
  # Identify PLZs that partially overlap multiple BWKs
  
  partial_matches <- st_join(plz, bwk, join = st_overlaps)
  
  # Manually coding out Augsburg 253 exceptions
  augsburg_plz <- c("82297", "86154", "86156", "86316", "86356", "86368", 
                    "86391", "86399", "86405", "86415", "86420", "86424", 
                    "86438", "86441", "86444", "86465", "86485", "86494", 
                    "86495", "86504", "86507", "86508", "86510", "86511", 
                    "86551", "86559", "86568", "86577", "86672", "86678", 
                    "86679", "86695", "86707", "86830", "86836", "86850", 
                    "86853", "86856", "86863", "86868", "86872", "86877")
  augsburg_oddity <- partial_matches %>%
    filter(wkr_nr == 253 & plz %in% augsburg_plz) %>%
    select(plz, plz_name, wkr_nr, wkr_name, land_nr, land_name, 
           plz_einwohner, plz_qkm, geometry) %>%
    mutate(
      wk_pct = NA
    ) %>%
    st_drop_geometry()
  
  # arrange by number for easier tracking
  partial_matches <- partial_matches %>%
    arrange(plz) %>%
    filter(!wkr_nr == 253)
  
  # setting a function to find shared area for each row
  calculate_intersection_area <- function(plz_code, wahlkreis_nummer) {
    plz_geom <- plz %>%
      filter(plz == plz_code) %>%
      st_geometry()
    bwk_geom <- bwk %>%
      filter(wkr_nr == wahlkreis_nummer) %>%
      st_geometry()
    intersection_geom <- st_intersection(plz_geom, bwk_geom)
    if (!is.null(intersection_geom)) {
      cat(paste(plz_code, ".", sep = ""))
      return(st_area(intersection_geom))
    } else {
      return(0)
    }
  }
  
  # time for some base r baby! calculating the areas of the intersections purrr
  partial_matches$intersection_area <- pmap_dbl(
    list(partial_matches$plz, partial_matches$wkr_nr), 
    calculate_intersection_area
    )
  
  partial_matches <- partial_matches %>%
    # finding the area of the PLZ itself
    mutate(
      plz_area = as.numeric(str_replace(st_area(geometry), " \\[m\\^2\\]", "")),
      wk_pct = intersection_area / plz_area
    ) %>%
    st_drop_geometry()
  
  # apply tolerance
  partial_matches <- partial_matches %>%
    filter(wk_pct > .25) %>%
    clean_names() %>%
    select(plz, plz_name, wkr_nr, wkr_name, land_nr, 
           land_name, plz_einwohner, plz_qkm, wk_pct)
  
  # 94 PLZ have multiple WK associated with them
  repeat_num <- partial_matches[c("plz", "wkr_nr")] %>%
    group_by(plz) %>%
    summarize(count = n()) %>%
    ungroup() %>%
    group_by(count) %>%
    summarise(n())
  
  # time for the big bad boy
  final_df <- rbind(rbind(full_contains, partial_matches), augsburg_oddity) %>%
    filter(!is.na(plz)) %>%
    arrange(plz) %>%
    select(plz, plz_name, wkr_nr, wkr_name, land_nr, land_name, 
           plz_einwohner, plz_qkm, wk_pct)
  
  # reset row names
  row.names(final_df) <- NULL
  
  # tada!!
  library(openxlsx)
  write.xlsx(final_df, "output/geo/plz_wkr_bridge.xlsx")
  write.csv(final_df, "output/geo/plz_wkr_bridge.csv", fileEncoding = "UTF-8")
  saveRDS(final_df, file = "output_data/geo/plz_wkr_bridge.rds")
  ```
</details>

2.815 PLZ sind ausschließlich in einem Wahlkreis enthalten. Die übrigen PLZ wurden paarweise mit allen Wahlbezirken auf räumliche Überschneidungen verglichen, wobei 12.119 PLZ-BWK-Paare entstanden. Auf der Grundlage einer Schwellenwertanalyse wurde für jedes PLZ-BWK-Paar ein Schwellenwert von 25 % PLZ-Abdeckung festgelegt.^[Insbesondere fielen mehr als 6.000 Paare aus der Tabelle heraus, wenn eine triviale Schwelle von 1 % räumlicher Abdeckung festgelegt wurde.] 

<details>
  <summary> PLZ-BWK Treshold Table </summary>
```{r threshold, print= TRUE}
sig_table <- readRDS("output/sig_table.rds")
reactable(sig_table,
  defaultColDef = colDef(
    align = "center",
    headerStyle = list(background = "#f7f7f8")
  ),
  columns = list(
    tolerance = colDef(format = colFormat(percent = TRUE, digits = 0), name = "Tolerance"),
    nrows = colDef(name = "PLZ-BWK Pairs", format = colFormat(separators = TRUE))
  ), 
  bordered = TRUE,
  highlight = TRUE
)
```

</details>

Letztendlich wurden 8.256 PLZs den 299 Wahlbezirken zugeordnet, wobei 91 Postleitzahlen auf 2 Wahlbezirke und 2 auf 3 Wahlbezirke verteilt waren [[`CSV`]("output_data/plz_wkr_bridge.csv")][[`RData`]("output_data/plz_wkr_bridge.rds")][[`XLSX`]("output_data/plz_wkr_bridge.xlsx")]. 

### ESF+-Ziele

### Geografische Informationen

## Datenquellen

### European Social Funds+

* Nordrhein Westfalen [[`XLSX`](https://www.mags.nrw/system/files/media/document/file/esf_2021-2027_liste_der_vorhaben.xlsx)]: Ministerium für Arbeit, Gesundheit und Soziales, 31.12.2023. 

### Geocoding

* Postleitzahl Shapefile [[`GeoJSON`](https://downloads.suche-postleitzahl.org/v2/public/plz-5stellig.geojson)]: Postleitzahlen Deutschland, 15.7.2023.^[[Open Database License](https://www.openstreetmap.org/copyright)]
* Bundestagwahlkreise Shapefile [[`GeoJSON`](https://www.bundeswahlleiterin.de/en/dam/jcr/f0ce06a7-188c-4ef3-b49b-5a66719d2b46/btw21_geometrie_wahlkreise_vg250_shp.zip)]: Bundeswahlleiter, 15.04.2020.
* Namen der Bundestagswahlkreise [[`CSV`](https://www.bundeswahlleiterin.de/dam/jcr/b46e4c9d-290c-4b96-a64b-0edee1c780a5/btw21_wahlkreisnamen_utf8.csv)]: Bundeswahlleiter, 15.04.2020.